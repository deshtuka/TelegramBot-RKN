## Документация по проекту телеграмм бота РосКомНадзора 

---

### Стек разработки:
* Python 3.9
  * pyTelegramBotAPI
  * Requests
* SQLite

---

### Кнопки быстрого действия:
* /start - начало. Вывод кнопок по созданию/получению заявок
* /settings - настройки учетной записи.
* /help - описание проекта и что зачем.
* /feedback - написать отзыв разработчику

---

### Список запросов совершаемых на сервер:
1) Авторизация:
    * [GET-запрос получения данных для авторизации](https://portal.rfc-revizor.ru/login/)
    * [GET-запрос скачивания картинки с капчей](https://portal.rfc-revizor.ru/captcha/{secretcodeId})
    * [POST-запрос авторизации с капчей](https://portal.rfc-revizor.ru/login/)
2) [POST-запрос создания заявки на дату](https://portal.rfc-revizor.ru/cabinet/myclaims-reports/create)
3) [GET-запрос на получение списка заявок](https://portal.rfc-revizor.ru/cabinet/myclaims-reports/)
4) [GET-запрос на скачивание заявки](https://portal.rfc-revizor.ru/cabinet/claims-reports/download/{archive_id}.zip)

---

### Получение доступа к сайту
1) Проверка данных в БД:
   - Наличие данных учетной записи
     - [x] В наличие: Перейти к следующему пункту
     - [ ] Отсутствуют: Перейти к шагу настройки УЗ.
   - Дата и время последней активности куков
     - [x] Активность больше 25 min: Перейти к шагу 2.
     - [ ] Активность меньше 25 min: Перейти к шагу "Основные кнопки действий".
2) Авторизация:
   - Отправить GET-запрос на получение данных авторизации и ссылки на капчу
     - [x] Успешно: Данные получены и сохранены. Сформирован url капчи.
     - [ ] Ошибка: Вывод сообщения "Сайт не работает, повторите попытку позже"
   - Отправить GET-запрос на скачивание картинки с капчей
     - [x] Успешно: Картинка загружена на диск.
     - [ ] Ошибка: Вывод сообщения "Сайт не работает, повторите попытку позже"
   - Пользователь ввел капчу с изображения
   - Отправить POST-запрос авторизации
     - [x] Успешно: Всё ОК. (данные в БД обновлены)
     - [ ] Ошибка: Вывод сообщения об ошибке с сайта (повтор ввода капчи / настройка УЗ / сайт не работает).

---

### Основные кнопки действий доступные пользователю:

### Кнопка "/start" -> "Создать заявку"
  0) Проверка сессии
     - [x] Успешно: Перейти к следующему шагу
     - [ ] Ошибка: Перейти к шагу авторизации
  1) Вывод кнопок пользователю для выбора даты создания заявки.
  2) Отправить POST-запрос с созданием заявки
     - [x] Заявка создана: Всё ОК
     - [ ] Заявка не создана: Вывод сообщения об ошибке с сайта. (необходима авторизация *шаг 2* или сайт не работает)
  4) Вывод информационного сообщения о создание заявки

### Кнопка "/start" -> "Получить заявку"
  0) Проверка сессии
     - [x] Успешно: Перейти к следующему шагу
     - [ ] Ошибка: Перейти к шагу авторизации
  1) Отправить GET-запрос на получение статуса отчетов
     - [x] Успешно: Получен список заявок со статусом
     - [ ] Ошибка: Вывод сообщения об ошибке с сайта. (необходима авторизация *шаг 2* или сайт не работает)
  2) Вывод кнопок пользователю с доступными для скачивания отчетов
  3) Отправить GET-запрос на скачивание отчета
     - [x] Успешно: Отчет скачен и выгружен пользователю
     - [ ] Ошибка: Вывод сообщения об ошибке с сайта. (необходима авторизация *шаг 2* или сайт не работает)

### Кнопка "/settings"
  1) Проверка наличия УЗ в БД
  2) Варианты действий пользователя:
     - Добавить данные аккаунт РКН в бот -> Перейти к шагу 3
     - Изменить сохраненные данные об аккаунте РКН в боте -> Перейти к шагу 3
     - Удалить аккаунт - Полностью удалить всю информацию
  3) Ввод "Логина" УЗ
     - [x] Введен: перейти к следующему шагу
     - [ ] Отмена: завершить настройку
  4) Ввод "Пароля" УЗ
     - [x] Введен: перейти к следующему шагу
     - [ ] Отмена: завершить настройку
  5) Сообщение "Данные аккаунта сохранены в БД"
  6) Вывод кнопок: "Создать заявку", "Получить заявку".

### Кнопка "/help"
  1) Краткое описание проекта и предназначение бота

### Кнопка "/feedback"
  1) Возможность пользователю написать сообщение разработчику

---

### Что нужно сделать (todo):

- [x] Переработать архитектуру проекта
- [x] Реализовать подробное логирование, где установить следующий стиль сообщений:
  - TRACE - технические (запросы/ответы к/от сервера/БД)
  - DEBUG - отладка кода разработчиком
  - INFO - действия пользователя
  - WARNING - предупреждение о неправильном действие (ошибке)
  - ERROR - ошибки нарушающие целостность программы
- [ ] Уменьшить кол-во обращений в базу данных (исключить обращение в БД при логирование)
- [x] Вынести все статические переменные в common (сообщения, константы, ...)
- [ ] Доработать базу данных
  - Добавить дату и время последней активности пользователя
  - Добавить дату и время последнего успешного запроса (куков)
- [ ] Добавить кнопку с возможностью "Написать разработчику"
- [ ] Добавить кнопку с описанием проекта
- [ ] Сократить кол-во запросов к сайту
- [ ] Автоматический разбор капчи* (на будущее)
- [ ] Написать на проект техническую документацию

